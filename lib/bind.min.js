var Bind=function(e){"use strict";function n(e){return(e+"").replace(/[<>]/g,function(e){return{">":"&gt;","<":"&lt;"}[e]})}function t(e,n){for(var t=e.length,r=0;r<t;r++)n(e[r],r,e)}function r(e,n){t("pop push reverse shift sort splice unshift".split(" "),function(t){this[t]=function(){this.__dirty=!0;var r=c({},l[t].apply(this,arguments));return delete this.__dirty,e&&n.ready&&e(this),r}.bind(this)}.bind(this));var r=this.length;return Object.defineProperty(this,"length",{configurable:!1,enumerable:!0,set:function(e){if(this.__dirty)return void(r=e);var n=1*e;return r!==n&&(n>r?this.push.apply(this,new Array(n-r)):this.splice(n),r=n),e},get:function(){return r}}),this}function i(l,d,p,y){if(y||(y=[]),p.ready&&d.__callback)return l;if(d instanceof a)return d;var v;try{var b=p.context||document;v=b.querySelectorAll.bind(b)}catch(e){}return t(Object.getOwnPropertyNames(d),function(a){if("__callback"!==a){var b,g=d[a],k=[].slice.call(y),_=function(e){return n(e)},m=f;k.push(a);var j=p.mapping[k.join(".")];o&&console.log("key: %s / %s",a,k.join("."),j),j&&"[object Object]"===j.toString()&&(j.callback&&(b=j.callback),j.transform&&(_=h(j.transform.bind({safe:n}))),j.parse&&(m=h(j.parse)),j=j.dom);var A;if("string"==typeof j?A=v(j||"☺"):e.Element&&j instanceof e.Element&&(A=[j]),"function"==typeof j)b=j;else if(A){0===A.length&&console.warn('No elements found against "'+j+'" selector');var O=["SELECT","INPUT","PROGRESS","TEXTAREA"];null!==g&&void 0!==g||(g=m(-1!==O.indexOf(A[0].nodeName)?A[0].hasOwnProperty("checked")?"on"===A[0].value?A[0].checked:A[0].value:A[0].value:A[0].innerHTML));var E=b;b=function(e){A=v(j||"☺"),A&&t(A,function(n){if(!n.__dirty)if(-1!==O.indexOf(n.nodeName)){var r;if(r="TEXTAREA"===n.nodeName?e:_(e,l),"checkbox"===n.type)if(e instanceof Array){var i=e.filter(function(e){if(e===n.value)return n.checked=n.value===e,!0});0===i.length&&(n.checked=!1)}else"boolean"==typeof e&&(n.checked=e);else if("radio"===n.type)n.checked=n.value===r;else if("number"==typeof n.value)try{n.value=1*r}catch(e){console.error(e.message)}else n.value=r}else{e instanceof Array||(e=[e]);var c=[];t(e,function(e){c.push(_(e,l))}),"object"==typeof c[0]?(n.innerHTML="",c.forEach(function(e){n.appendChild(e)})):n.innerHTML=c.join("")}}),E&&E.apply(l,arguments)},t(A,function(e){if("INPUT"===e.nodeName||"SELECT"===e.nodeName||"TEXTAREA"===e.nodeName){var n=function(){this.__dirty=!0;var n;if("checkbox"===e.type){var r=(e.form||document).querySelectorAll('input[name="'+e.name+'"][type="checkbox"]');if(l[a]instanceof Array){var i=[];t(r,function(e){e.checked&&i.push(m("on"===e.value?e.checked:e.value))}),n=i}else n=m("on"===this.value?this.checked:this.value)}else"radio"===e.type&&(n=m("on"===this.value?this.checked:this.value)),n=m("number"==typeof l[a]?1*this.value:this.value);void 0===n&&(n=this.value),l[a]=n,this.__dirty=!1},r={checkbox:"change",radio:"change","select-one":"change","select-multiple":"change"}[e.type];e.addEventListener(r||"input",n)}})}b&&k.reduce(function(e,n,t,r){return e[n]||(e[n]={}),t===r.length-1&&(e[n].__callback=b),e[n]},p.callbacks);var N=function(e){var n=[],t=[],r=p.instance,i=!1,l=!1;o&&console.log("> finding callback for %s",a,k),k.reduce(function(a,o,s){if(a&&a[o]&&o){if(null===(r=r[o])||void 0===r)return a[o]||{};if("function"==typeof a[o].__callback){var u=s===k.length-1?e:r;r.__dirty&&(i=!0),s===k.length-1&&a[o].__callback&&(l={path:k.join("."),callback:a[o].__callback,instance:u}),i||(t.push(c(u instanceof Array?[]:{},u)),n.push(a[o].__callback))}return a[o]||{}}},p.callbacks),i||(t.reverse(),n.reverse().forEach(function(e,n){e.call(p.instance,t[n])})),i&&l&&(r=l.instance,l.callback.call(p.instance,c(r instanceof Array?[]:{},r)))},T={configurable:!0,enumerable:!0,set:function(e){var n=g!==e?g:void 0;g=!p.ready||typeof e!==u||null===e||s(e)||e.__callback?s(e)?i(new r(N,p),e,p,k):e:i(l[a]?c({},l[a]):{},e,p,k),o&&console.log("set: key(%s): %s -> %s",a,JSON.stringify(n),JSON.stringify(e)),p.ready?N(g):void 0!==p.mapping[k.join(".")]&&p.deferred.push(N.bind(l,g,n))},get:function(){return g}};try{Object.defineProperty(l,a,T)}catch(e){o&&console.log("failed on Object.defineProperty",e.toString(),e.stack)}typeof g!==u||null===g||s(g)?s(g)?l[a]=i(new r(N,p),g,p,k):l instanceof r||(l[a]=g):l[a]=i(l[a]||{},g,p,k)}}),l instanceof r&&l.push.apply(l,d),l}function c(e,n){return n instanceof Object?(t(Object.getOwnPropertyNames(n),function(t){var r=n[t];a.prototype[t]||"__callback"===t||(typeof r===u&&null!==r&&r instanceof Array?e[t]=[].map.call(r,function(n){return n instanceof Object?c(e[t]||{},n):n}):typeof r!==u||null===r||s(r)||"[Object object]"!==r.toString()?e[t]=r:e[t]=c(e[t]||{},r))}),e):n}function a(n,r,c){if(!this||this===e)return new a(n,r);var o={context:c||e.document,mapping:r||{},callbacks:{},deferred:[],ready:!1,instance:this};return i(this,n,o),o.ready=!0,o.deferred.length&&t(o.deferred,function(e){e()}),this}if(!Function.bind||!Object.defineProperty)throw new Error("Prerequisite APIs not available.");var o=!1,l=[],s=Array.isArray,u="object",f=function(e){return e},h=function(e){return function(){try{return e.apply(this,arguments)}catch(e){console.error(e.stack?e.stack:e)}}};return r.prototype=[],a.prototype.__export=function(){return c({},this)},a}(this);"undefined"!=typeof exports&&(module.exports=Bind);
